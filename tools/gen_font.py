#!/usr/bin/env python3
"""
gen_font.py
===========
Generates the bitmap font for the GBC-Template project.

Outputs
-------
  res/font.png   – 128x56 indexed PNG (16 wide × 7 rows, 8x8 per char)
  res/font.c     – GBDK tile data and palette
  res/font.h     – Header with FONT_TILE_COUNT and special-char tile offsets

The font covers ASCII 32-127 (96 chars) plus 5 extra glyphs at indices 96-100:
  96 – ♠ spade
  97 – ♣ club
  98 – ♥ heart
  99 – ♦ diamond
 100 – ► cursor arrow right

The font palette is loaded at GBC background palette slot 2:
  set_bkg_palette(2, FONT_PALETTE_COUNT, font_palettes);
draw_text() writes VRAM bank-1 attribute 0x02 so text always uses this palette.

For red text (e.g. hearts in HUD), use a separate red-text palette at slot 4:
  Tile attribute 0x04 selects red-text palette with color 1 = red.

Reuse: edit FONT_BITMAPS to change glyphs, then run:
  python3 tools/gen_font.py
"""

import os, sys

TOOLS_DIR = os.path.dirname(os.path.abspath(__file__))
REPO_ROOT = os.path.dirname(TOOLS_DIR)
sys.path.insert(0, TOOLS_DIR)

from gbc_asset_builder import make_indexed_png, write_font_files

# ---------------------------------------------------------------------------
# Font palette
# ---------------------------------------------------------------------------
PALETTE_COLORS = [
    (155, 200, 234),   # 0 – background (sky-matching)
    (  0,   0,   0),   # 1 – text (black)
    (170, 170, 170),   # 2 – unused / mid-grey
    ( 85,  85,  85),   # 3 – unused / dark-grey
]

PNG_PALETTE = PALETTE_COLORS

# ---------------------------------------------------------------------------
# ASCII 32–127 glyph bitmaps (96 entries, 8 bytes each)
# Each byte encodes 8 pixels; bit 7 = leftmost pixel.
# ---------------------------------------------------------------------------
FONT_BITMAPS = [
    # 32 ' '
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    # 33 '!'
    [0x10,0x10,0x10,0x10,0x10,0x00,0x10,0x00],
    # 34 '"'
    [0x28,0x28,0x00,0x00,0x00,0x00,0x00,0x00],
    # 35 '#'
    [0x28,0x7C,0x28,0x7C,0x28,0x00,0x00,0x00],
    # 36 '$'
    [0x10,0x3C,0x30,0x1C,0x78,0x10,0x00,0x00],
    # 37 '%'
    [0x64,0x68,0x10,0x2C,0x4C,0x00,0x00,0x00],
    # 38 '&'
    [0x30,0x48,0x30,0x48,0x34,0x00,0x00,0x00],
    # 39 "'"
    [0x10,0x10,0x00,0x00,0x00,0x00,0x00,0x00],
    # 40 '('
    [0x08,0x10,0x10,0x10,0x08,0x00,0x00,0x00],
    # 41 ')'
    [0x20,0x10,0x10,0x10,0x20,0x00,0x00,0x00],
    # 42 '*'
    [0x00,0x28,0x10,0x28,0x00,0x00,0x00,0x00],
    # 43 '+'
    [0x00,0x10,0x38,0x10,0x00,0x00,0x00,0x00],
    # 44 ','
    [0x00,0x00,0x00,0x00,0x10,0x10,0x00,0x00],
    # 45 '-'
    [0x00,0x00,0x38,0x00,0x00,0x00,0x00,0x00],
    # 46 '.'
    [0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00],
    # 47 '/'
    [0x04,0x08,0x10,0x20,0x40,0x00,0x00,0x00],
    # 48 '0'
    [0x38,0x4C,0x54,0x64,0x38,0x00,0x00,0x00],
    # 49 '1'
    [0x10,0x30,0x10,0x10,0x38,0x00,0x00,0x00],
    # 50 '2'
    [0x38,0x44,0x18,0x20,0x7C,0x00,0x00,0x00],
    # 51 '3'
    [0x78,0x04,0x38,0x04,0x78,0x00,0x00,0x00],
    # 52 '4'
    [0x08,0x18,0x28,0x7C,0x08,0x00,0x00,0x00],
    # 53 '5'
    [0x7C,0x40,0x78,0x04,0x78,0x00,0x00,0x00],
    # 54 '6'
    [0x38,0x40,0x78,0x44,0x38,0x00,0x00,0x00],
    # 55 '7'
    [0x7C,0x04,0x08,0x10,0x20,0x00,0x00,0x00],
    # 56 '8'
    [0x38,0x44,0x38,0x44,0x38,0x00,0x00,0x00],
    # 57 '9'
    [0x38,0x44,0x3C,0x04,0x38,0x00,0x00,0x00],
    # 58 ':'
    [0x00,0x10,0x00,0x10,0x00,0x00,0x00,0x00],
    # 59 ';'
    [0x00,0x10,0x00,0x10,0x10,0x00,0x00,0x00],
    # 60 '<'
    [0x00,0x08,0x10,0x08,0x00,0x00,0x00,0x00],
    # 61 '='
    [0x00,0x38,0x00,0x38,0x00,0x00,0x00,0x00],
    # 62 '>'
    [0x00,0x20,0x10,0x20,0x00,0x00,0x00,0x00],
    # 63 '?'
    [0x38,0x04,0x18,0x00,0x10,0x00,0x00,0x00],
    # 64 '@'
    [0x38,0x4C,0x54,0x5C,0x30,0x00,0x00,0x00],
    # 65 'A'
    [0x38,0x44,0x7C,0x44,0x44,0x00,0x00,0x00],
    # 66 'B'
    [0x78,0x44,0x78,0x44,0x78,0x00,0x00,0x00],
    # 67 'C'
    [0x38,0x44,0x40,0x44,0x38,0x00,0x00,0x00],
    # 68 'D'
    [0x78,0x44,0x44,0x44,0x78,0x00,0x00,0x00],
    # 69 'E'
    [0x7C,0x40,0x78,0x40,0x7C,0x00,0x00,0x00],
    # 70 'F'
    [0x7C,0x40,0x78,0x40,0x40,0x00,0x00,0x00],
    # 71 'G'
    [0x38,0x40,0x5C,0x44,0x38,0x00,0x00,0x00],
    # 72 'H'
    [0x44,0x44,0x7C,0x44,0x44,0x00,0x00,0x00],
    # 73 'I'
    [0x7C,0x10,0x10,0x10,0x7C,0x00,0x00,0x00],
    # 74 'J'
    [0x0C,0x04,0x04,0x44,0x38,0x00,0x00,0x00],
    # 75 'K'
    [0x48,0x50,0x60,0x50,0x48,0x00,0x00,0x00],
    # 76 'L'
    [0x40,0x40,0x40,0x40,0x7C,0x00,0x00,0x00],
    # 77 'M'
    [0x44,0x6C,0x54,0x44,0x44,0x00,0x00,0x00],
    # 78 'N'
    [0x44,0x64,0x54,0x4C,0x44,0x00,0x00,0x00],
    # 79 'O'
    [0x38,0x44,0x44,0x44,0x38,0x00,0x00,0x00],
    # 80 'P'
    [0x78,0x44,0x78,0x40,0x40,0x00,0x00,0x00],
    # 81 'Q'
    [0x38,0x44,0x54,0x48,0x34,0x00,0x00,0x00],
    # 82 'R'
    [0x78,0x44,0x78,0x50,0x48,0x00,0x00,0x00],
    # 83 'S'
    [0x3C,0x40,0x38,0x04,0x78,0x00,0x00,0x00],
    # 84 'T'
    [0x7C,0x10,0x10,0x10,0x10,0x00,0x00,0x00],
    # 85 'U'
    [0x44,0x44,0x44,0x44,0x38,0x00,0x00,0x00],
    # 86 'V'
    [0x44,0x44,0x28,0x28,0x10,0x00,0x00,0x00],
    # 87 'W'
    [0x44,0x44,0x54,0x6C,0x44,0x00,0x00,0x00],
    # 88 'X'
    [0x44,0x28,0x10,0x28,0x44,0x00,0x00,0x00],
    # 89 'Y'
    [0x44,0x28,0x10,0x10,0x10,0x00,0x00,0x00],
    # 90 'Z'
    [0x7C,0x08,0x10,0x20,0x7C,0x00,0x00,0x00],
    # 91 '['
    [0x30,0x20,0x20,0x20,0x30,0x00,0x00,0x00],
    # 92 '\\'
    [0x40,0x20,0x10,0x08,0x04,0x00,0x00,0x00],
    # 93 ']'
    [0x18,0x08,0x08,0x08,0x18,0x00,0x00,0x00],
    # 94 '^'
    [0x10,0x28,0x00,0x00,0x00,0x00,0x00,0x00],
    # 95 '_'
    [0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00],
    # 96 '`'
    [0x20,0x10,0x00,0x00,0x00,0x00,0x00,0x00],
    # 97 'a'
    [0x00,0x38,0x04,0x3C,0x3C,0x00,0x00,0x00],
    # 98 'b'
    [0x40,0x78,0x44,0x44,0x78,0x00,0x00,0x00],
    # 99 'c'
    [0x00,0x38,0x40,0x40,0x38,0x00,0x00,0x00],
    # 100 'd'
    [0x04,0x3C,0x44,0x44,0x3C,0x00,0x00,0x00],
    # 101 'e'
    [0x00,0x38,0x44,0x78,0x38,0x00,0x00,0x00],
    # 102 'f'
    [0x18,0x20,0x70,0x20,0x20,0x00,0x00,0x00],
    # 103 'g'
    [0x00,0x3C,0x44,0x3C,0x04,0x38,0x00,0x00],
    # 104 'h'
    [0x40,0x78,0x44,0x44,0x44,0x00,0x00,0x00],
    # 105 'i'
    [0x00,0x10,0x00,0x10,0x10,0x00,0x00,0x00],
    # 106 'j'
    [0x00,0x08,0x00,0x08,0x08,0x30,0x00,0x00],
    # 107 'k'
    [0x40,0x48,0x50,0x60,0x58,0x00,0x00,0x00],
    # 108 'l'
    [0x30,0x10,0x10,0x10,0x38,0x00,0x00,0x00],
    # 109 'm'
    [0x00,0x68,0x54,0x44,0x44,0x00,0x00,0x00],
    # 110 'n'
    [0x00,0x78,0x44,0x44,0x44,0x00,0x00,0x00],
    # 111 'o'
    [0x00,0x38,0x44,0x44,0x38,0x00,0x00,0x00],
    # 112 'p'
    [0x00,0x78,0x44,0x78,0x40,0x40,0x00,0x00],
    # 113 'q'
    [0x00,0x3C,0x44,0x3C,0x04,0x04,0x00,0x00],
    # 114 'r'
    [0x00,0x2C,0x30,0x20,0x20,0x00,0x00,0x00],
    # 115 's'
    [0x00,0x3C,0x60,0x1C,0x78,0x00,0x00,0x00],
    # 116 't'
    [0x20,0x70,0x20,0x24,0x18,0x00,0x00,0x00],
    # 117 'u'
    [0x00,0x44,0x44,0x44,0x3C,0x00,0x00,0x00],
    # 118 'v'
    [0x00,0x44,0x44,0x28,0x10,0x00,0x00,0x00],
    # 119 'w'
    [0x00,0x44,0x54,0x6C,0x44,0x00,0x00,0x00],
    # 120 'x'
    [0x00,0x44,0x28,0x10,0x28,0x44,0x00,0x00],
    # 121 'y'
    [0x00,0x44,0x28,0x18,0x08,0x30,0x00,0x00],
    # 122 'z'
    [0x00,0x7C,0x18,0x30,0x7C,0x00,0x00,0x00],
    # 123 '{'
    [0x08,0x10,0x20,0x10,0x08,0x00,0x00,0x00],
    # 124 '|'
    [0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x00],
    # 125 '}'
    [0x20,0x10,0x08,0x10,0x20,0x00,0x00,0x00],
    # 126 '~'
    [0x00,0x24,0x54,0x48,0x00,0x00,0x00,0x00],
    # 127 DEL (full block)
    [0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x00],

    # ----- Extra glyphs (indices 96-100, tile offsets from font base) -----

    # 96: ♠ spade (5-wide, upward-pointing)
    [0x10,0x38,0x7C,0xFE,0x7C,0x28,0x7C,0x00],
    # 97: ♣ club (three lobes + stem)
    [0x38,0x38,0xFE,0x7C,0x38,0x28,0x7C,0x00],
    # 98: ♥ heart (5-wide, colour 1 used for fill → red when attr=4)
    [0x6C,0xFE,0xFE,0x7C,0x38,0x10,0x00,0x00],
    # 99: ♦ diamond
    [0x10,0x38,0x7C,0xFE,0x7C,0x38,0x10,0x00],
    # 100: ► cursor arrow right
    [0x40,0x60,0x70,0x78,0x70,0x60,0x40,0x00],
]

assert len(FONT_BITMAPS) == 101, f"Expected 101 glyphs, got {len(FONT_BITMAPS)}"

# Extra #define entries for the special tile offsets (relative to font base in VRAM)
EXTRA_DEFINES = [
    ('FONT_TILE_SPADE',   96, 'tile offset for ♠ spade'),
    ('FONT_TILE_CLUB',    97, 'tile offset for ♣ club'),
    ('FONT_TILE_HEART',   98, 'tile offset for ♥ heart (use HUD_RED_PALETTE_SLOT for red)'),
    ('FONT_TILE_DIAMOND', 99, 'tile offset for ♦ diamond'),
    ('FONT_TILE_CURSOR',  100,'tile offset for ► cursor'),
]


def _bitmap_to_tile(bitmap_row_bytes):
    tile = []
    for byte_val in bitmap_row_bytes:
        row = [1 if (byte_val & (0x80 >> bit)) else 0 for bit in range(8)]
        tile.append(row)
    return tile


def main():
    out_dir = os.path.join(REPO_ROOT, 'res')
    os.makedirs(out_dir, exist_ok=True)

    tiles = [_bitmap_to_tile(bm) for bm in FONT_BITMAPS]

    # Build 128×56 PNG: 16 chars wide × 7 rows tall (101 chars rounded up to 112)
    sheet_cols = 16
    sheet_rows = (len(tiles) + sheet_cols - 1) // sheet_cols  # = 7
    sheet_w, sheet_h = sheet_cols * 8, sheet_rows * 8
    pixel_grid = [[0] * sheet_w for _ in range(sheet_h)]
    for idx, tile in enumerate(tiles):
        tx = (idx % sheet_cols) * 8
        ty = (idx // sheet_cols) * 8
        for r in range(8):
            for c in range(8):
                pixel_grid[ty + r][tx + c] = tile[r][c]

    png_path = os.path.join(out_dir, 'font.png')
    make_indexed_png(pixel_grid, PNG_PALETTE, png_path)
    print(f'Written {png_path}  ({sheet_w}x{sheet_h})')

    write_font_files(
        name='font',
        tiles=tiles,
        palette_colors=PALETTE_COLORS,
        extra_defines=EXTRA_DEFINES,
        out_dir=out_dir,
    )


if __name__ == '__main__':
    main()
