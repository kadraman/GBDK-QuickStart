#!/usr/bin/env python3
"""
gen_font.py
===========
Generates the bitmap font tileset for the GBC-Template project.

Outputs
-------
  res/font.png   - 128x48 indexed PNG (16 chars wide x 6 rows tall, 8x8 per char)
  res/font.c     - GBDK tile data and palette
  res/font.h     - Corresponding header file

The font covers printable ASCII 32-127 (96 characters) in a compact 5x7 pixel
stroke on an 8x8 tile grid.  Only colour indices 0 and 1 are used:

  Palette colour 0 - background (sky-matching blue by default)
  Palette colour 1 - text colour (black by default)

The font palette is loaded at GBC background palette slot 2:
  set_bkg_palette(2, FONT_PALETTE_COUNT, font_palettes);

and draw_text() assigns VRAM-bank-1 attribute 0x02 to each text tile so it
always renders with the correct palette regardless of what palette is used for
the surrounding background.

Reuse
-----
To create a different font, edit FONT_BITMAPS below (8 rows of 8-bit patterns
per character; only the low plane is used so colours 0 and 1 are sufficient).
Then run:  python3 tools/gen_font.py

Each entry in FONT_BITMAPS is a list of 8 bytes (one per pixel row) where
bit 6 of each byte = leftmost active pixel (column 1 in the 8-pixel tile).
"""

import os
import sys

TOOLS_DIR = os.path.dirname(os.path.abspath(__file__))
REPO_ROOT = os.path.dirname(TOOLS_DIR)
sys.path.insert(0, TOOLS_DIR)

from gbc_asset_builder import make_indexed_png, write_font_files

# ---------------------------------------------------------------------------
# GBC font palette colours
# ---------------------------------------------------------------------------
PALETTE_COLORS = [
    (155, 200, 234),   # 0 – background (sky-matching blue)
    (  0,   0,   0),   # 1 – text (black)
    (170, 170, 170),   # 2 – unused / mid-grey
    ( 85,  85,  85),   # 3 – unused / dark-grey
]

# PNG palette for the generated font.png
PNG_PALETTE = PALETTE_COLORS

# ---------------------------------------------------------------------------
# 5×7 pixel bitmap font, one byte per row, 8 rows per glyph.
# Each byte encodes the 8 pixels of that row; bit 7 = leftmost pixel.
# Only bits 6-2 are typically used, giving 5 active pixel columns.
# ASCII 32 (space) through ASCII 127 (DEL placeholder).
# ---------------------------------------------------------------------------
FONT_BITMAPS = [
    # 32 ' '
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 33 '!'
    [0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10, 0x00],
    # 34 '"'
    [0x28, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 35 '#'
    [0x28, 0x7C, 0x28, 0x7C, 0x28, 0x00, 0x00, 0x00],
    # 36 '$'
    [0x10, 0x3C, 0x30, 0x1C, 0x78, 0x10, 0x00, 0x00],
    # 37 '%'
    [0x64, 0x68, 0x10, 0x2C, 0x4C, 0x00, 0x00, 0x00],
    # 38 '&'
    [0x30, 0x48, 0x30, 0x48, 0x34, 0x00, 0x00, 0x00],
    # 39 "'"
    [0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 40 '('
    [0x08, 0x10, 0x10, 0x10, 0x08, 0x00, 0x00, 0x00],
    # 41 ')'
    [0x20, 0x10, 0x10, 0x10, 0x20, 0x00, 0x00, 0x00],
    # 42 '*'
    [0x00, 0x28, 0x10, 0x28, 0x00, 0x00, 0x00, 0x00],
    # 43 '+'
    [0x00, 0x10, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00],
    # 44 ','
    [0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x00, 0x00],
    # 45 '-'
    [0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 46 '.'
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00],
    # 47 '/'
    [0x04, 0x08, 0x10, 0x20, 0x40, 0x00, 0x00, 0x00],
    # 48 '0'
    [0x38, 0x4C, 0x54, 0x64, 0x38, 0x00, 0x00, 0x00],
    # 49 '1'
    [0x10, 0x30, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00],
    # 50 '2'
    [0x38, 0x44, 0x18, 0x20, 0x7C, 0x00, 0x00, 0x00],
    # 51 '3'
    [0x78, 0x04, 0x38, 0x04, 0x78, 0x00, 0x00, 0x00],
    # 52 '4'
    [0x08, 0x18, 0x28, 0x7C, 0x08, 0x00, 0x00, 0x00],
    # 53 '5'
    [0x7C, 0x40, 0x78, 0x04, 0x78, 0x00, 0x00, 0x00],
    # 54 '6'
    [0x38, 0x40, 0x78, 0x44, 0x38, 0x00, 0x00, 0x00],
    # 55 '7'
    [0x7C, 0x04, 0x08, 0x10, 0x20, 0x00, 0x00, 0x00],
    # 56 '8'
    [0x38, 0x44, 0x38, 0x44, 0x38, 0x00, 0x00, 0x00],
    # 57 '9'
    [0x38, 0x44, 0x3C, 0x04, 0x38, 0x00, 0x00, 0x00],
    # 58 ':'
    [0x00, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00],
    # 59 ';'
    [0x00, 0x10, 0x00, 0x10, 0x10, 0x00, 0x00, 0x00],
    # 60 '<'
    [0x00, 0x08, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00],
    # 61 '='
    [0x00, 0x38, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00],
    # 62 '>'
    [0x00, 0x20, 0x10, 0x20, 0x00, 0x00, 0x00, 0x00],
    # 63 '?'
    [0x38, 0x04, 0x18, 0x00, 0x10, 0x00, 0x00, 0x00],
    # 64 '@'
    [0x38, 0x4C, 0x54, 0x5C, 0x30, 0x00, 0x00, 0x00],
    # 65 'A'
    [0x38, 0x44, 0x7C, 0x44, 0x44, 0x00, 0x00, 0x00],
    # 66 'B'
    [0x78, 0x44, 0x78, 0x44, 0x78, 0x00, 0x00, 0x00],
    # 67 'C'
    [0x38, 0x44, 0x40, 0x44, 0x38, 0x00, 0x00, 0x00],
    # 68 'D'
    [0x78, 0x44, 0x44, 0x44, 0x78, 0x00, 0x00, 0x00],
    # 69 'E'
    [0x7C, 0x40, 0x78, 0x40, 0x7C, 0x00, 0x00, 0x00],
    # 70 'F'
    [0x7C, 0x40, 0x78, 0x40, 0x40, 0x00, 0x00, 0x00],
    # 71 'G'
    [0x38, 0x40, 0x5C, 0x44, 0x38, 0x00, 0x00, 0x00],
    # 72 'H'
    [0x44, 0x44, 0x7C, 0x44, 0x44, 0x00, 0x00, 0x00],
    # 73 'I'
    [0x7C, 0x10, 0x10, 0x10, 0x7C, 0x00, 0x00, 0x00],
    # 74 'J'
    [0x0C, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00],
    # 75 'K'
    [0x48, 0x50, 0x60, 0x50, 0x48, 0x00, 0x00, 0x00],
    # 76 'L'
    [0x40, 0x40, 0x40, 0x40, 0x7C, 0x00, 0x00, 0x00],
    # 77 'M'
    [0x44, 0x6C, 0x54, 0x44, 0x44, 0x00, 0x00, 0x00],
    # 78 'N'
    [0x44, 0x64, 0x54, 0x4C, 0x44, 0x00, 0x00, 0x00],
    # 79 'O'
    [0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00],
    # 80 'P'
    [0x78, 0x44, 0x78, 0x40, 0x40, 0x00, 0x00, 0x00],
    # 81 'Q'
    [0x38, 0x44, 0x54, 0x48, 0x34, 0x00, 0x00, 0x00],
    # 82 'R'
    [0x78, 0x44, 0x78, 0x50, 0x48, 0x00, 0x00, 0x00],
    # 83 'S'
    [0x3C, 0x40, 0x38, 0x04, 0x78, 0x00, 0x00, 0x00],
    # 84 'T'
    [0x7C, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00],
    # 85 'U'
    [0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00],
    # 86 'V'
    [0x44, 0x44, 0x28, 0x28, 0x10, 0x00, 0x00, 0x00],
    # 87 'W'
    [0x44, 0x44, 0x54, 0x6C, 0x44, 0x00, 0x00, 0x00],
    # 88 'X'
    [0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00],
    # 89 'Y'
    [0x44, 0x28, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00],
    # 90 'Z'
    [0x7C, 0x08, 0x10, 0x20, 0x7C, 0x00, 0x00, 0x00],
    # 91 '['
    [0x30, 0x20, 0x20, 0x20, 0x30, 0x00, 0x00, 0x00],
    # 92 '\\'
    [0x40, 0x20, 0x10, 0x08, 0x04, 0x00, 0x00, 0x00],
    # 93 ']'
    [0x18, 0x08, 0x08, 0x08, 0x18, 0x00, 0x00, 0x00],
    # 94 '^'
    [0x10, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 95 '_'
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x00],
    # 96 '`'
    [0x20, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 97 'a'
    [0x00, 0x38, 0x04, 0x3C, 0x3C, 0x00, 0x00, 0x00],
    # 98 'b'
    [0x40, 0x78, 0x44, 0x44, 0x78, 0x00, 0x00, 0x00],
    # 99 'c'
    [0x00, 0x38, 0x40, 0x40, 0x38, 0x00, 0x00, 0x00],
    # 100 'd'
    [0x04, 0x3C, 0x44, 0x44, 0x3C, 0x00, 0x00, 0x00],
    # 101 'e'
    [0x00, 0x38, 0x44, 0x78, 0x38, 0x00, 0x00, 0x00],
    # 102 'f'
    [0x18, 0x20, 0x70, 0x20, 0x20, 0x00, 0x00, 0x00],
    # 103 'g'
    [0x00, 0x3C, 0x44, 0x3C, 0x04, 0x38, 0x00, 0x00],
    # 104 'h'
    [0x40, 0x78, 0x44, 0x44, 0x44, 0x00, 0x00, 0x00],
    # 105 'i'
    [0x00, 0x10, 0x00, 0x10, 0x10, 0x00, 0x00, 0x00],
    # 106 'j'
    [0x00, 0x08, 0x00, 0x08, 0x08, 0x30, 0x00, 0x00],
    # 107 'k'
    [0x40, 0x48, 0x50, 0x60, 0x58, 0x00, 0x00, 0x00],
    # 108 'l'
    [0x30, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00],
    # 109 'm'
    [0x00, 0x68, 0x54, 0x44, 0x44, 0x00, 0x00, 0x00],
    # 110 'n'
    [0x00, 0x78, 0x44, 0x44, 0x44, 0x00, 0x00, 0x00],
    # 111 'o'
    [0x00, 0x38, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00],
    # 112 'p'
    [0x00, 0x78, 0x44, 0x78, 0x40, 0x40, 0x00, 0x00],
    # 113 'q'
    [0x00, 0x3C, 0x44, 0x3C, 0x04, 0x04, 0x00, 0x00],
    # 114 'r'
    [0x00, 0x2C, 0x30, 0x20, 0x20, 0x00, 0x00, 0x00],
    # 115 's'
    [0x00, 0x3C, 0x60, 0x1C, 0x78, 0x00, 0x00, 0x00],
    # 116 't'
    [0x20, 0x70, 0x20, 0x24, 0x18, 0x00, 0x00, 0x00],
    # 117 'u'
    [0x00, 0x44, 0x44, 0x44, 0x3C, 0x00, 0x00, 0x00],
    # 118 'v'
    [0x00, 0x44, 0x44, 0x28, 0x10, 0x00, 0x00, 0x00],
    # 119 'w'
    [0x00, 0x44, 0x54, 0x6C, 0x44, 0x00, 0x00, 0x00],
    # 120 'x'
    [0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00],
    # 121 'y'
    [0x00, 0x44, 0x28, 0x18, 0x08, 0x30, 0x00, 0x00],
    # 122 'z'
    [0x00, 0x7C, 0x18, 0x30, 0x7C, 0x00, 0x00, 0x00],
    # 123 '{'
    [0x08, 0x10, 0x20, 0x10, 0x08, 0x00, 0x00, 0x00],
    # 124 '|'
    [0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00],
    # 125 '}'
    [0x20, 0x10, 0x08, 0x10, 0x20, 0x00, 0x00, 0x00],
    # 126 '~'
    [0x00, 0x24, 0x54, 0x48, 0x00, 0x00, 0x00, 0x00],
    # 127 (DEL placeholder – fully filled block)
    [0x7C, 0x7C, 0x7C, 0x7C, 0x7C, 0x7C, 0x7C, 0x00],
]

assert len(FONT_BITMAPS) == 96, f"Expected 96 glyphs, got {len(FONT_BITMAPS)}"


def _bitmap_to_tile(bitmap_row_bytes):
    """Convert 8 bitmap bytes (one per row) to an 8x8 pixel grid (colour 0/1)."""
    tile = []
    for byte_val in bitmap_row_bytes:
        row = []
        for bit in range(8):
            row.append(1 if (byte_val & (0x80 >> bit)) else 0)
        tile.append(row)
    return tile


# ---------------------------------------------------------------------------
# main
# ---------------------------------------------------------------------------
def main():
    out_dir = os.path.join(REPO_ROOT, 'res')
    os.makedirs(out_dir, exist_ok=True)

    # Build tile pixel data from bitmaps
    tiles = [_bitmap_to_tile(bm) for bm in FONT_BITMAPS]

    # Build 128x48 font sheet PNG (16 chars wide × 6 rows tall)
    sheet_w, sheet_h = 16 * 8, 6 * 8
    pixel_grid = [[0] * sheet_w for _ in range(sheet_h)]
    for idx, tile in enumerate(tiles):
        tx = (idx % 16) * 8
        ty = (idx // 16) * 8
        for r in range(8):
            for c in range(8):
                pixel_grid[ty + r][tx + c] = tile[r][c]

    png_path = os.path.join(out_dir, 'font.png')
    png_saved = make_indexed_png(pixel_grid, PNG_PALETTE, png_path)
    print(f'Written {png_saved}')

    write_font_files(
        name='font',
        tiles=tiles,
        palette_colors=PALETTE_COLORS,
        out_dir=out_dir,
    )


if __name__ == '__main__':
    main()
